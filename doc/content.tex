\section{Prerequisites}

\subsection{Naoqi workspace preparation}
\noindent It is recommended to work with qibuild workspaces when developing software for Softbank robots. Qibuild is a
convenience wrapper over CMake. Hence, the following steps are recommended
to work with humoto-pepper-controller within a qibuild workspace (unless existing workspace is to be used):

\begin{enumerate}
\item \texttt{mkdir /path/to/workspace/}
\item \texttt{cd /path/to/workspace/; qibuild init}
\item \texttt{cp -R /path/to/sdk /path/to/workspace/sdk}
\item \texttt{qitoolchain create mytoolchain /path/to/workspace/sdk/toolchain.xml}
\item \texttt{qibuild add-config mytoolchain -t mytoolchain --default}
\item \texttt{cd /path/to/workspace/; git clone <controller-pepper>}
\end{enumerate}

\noindent For the steps above it is assumed that qibuild is installed onto the system. It can be installed using for example pip
python packages manager.

\subsection{Compilation}
\noindent For compilation of the code the Aldebaran (Softbank Robotics) cross-compilation toolchain is required. The
controller has been developed using the toolchain of version: ctc-linux32-atom-2.4.3.28. Hence, it is recommended to use
this toolchain version. It can be obtained from the Aldebaran's official repositories (after registration).\\

\noindent To compile:
\noindent If your cross-compilation toolchain is named \texttt{'mytoolchain'}:

- Type \texttt{'make controller-pepper'} inside the root directory of the project.\\

\noindent If your toolchain has a different name:

- Type \texttt{'make controller-pepper TC=name-of-your-toolchain'}.\\

\noindent Inside cmake input script \texttt{pepper\_controller.cmake} located inside cmake directory, user can enable or disable
options for using hot-starting and logging as well as specify the desired solver to be used.\\

\noindent The following compilation options are available for use with CMake:\\ \\
\begin{tabular}{|l|p{5cm}|}
\hline
Option & Description \\
\hline
\texttt{CONTROLLER\_MPC\_HOTSTARTING\_ENABLED} & This boolean option activates hotstarting for the MPC resolution.\\
\hline
\texttt{CONTROLLER\_LOGGING\_ENABLED} & This boolean option activates logging.\\ \hline
\texttt{CONTROLLER\_HUMOTO\_MPC\_SOLVER\_NAMESPACE} & This variable specifies the name of the solver used for
MPC resolution. When using it make sure humoto is compiled with the respective solver. \\ \hline
\texttt{CONTROLLER\_HUMOTO\_IK\_SOLVER\_NAMESPACE} & This variable specifies the name of the solver used for IK
resolution. When using it make sure humoto is compiled with the respective solver.\\ 
\hline
\end{tabular} \\

\noindent Inside the same directory user can also specify options for humoto compilation inside \texttt{humoto.cmake} file.
For possible options refer to the documentation of humoto.

\subsection{Installation}
\noindent The project compiles down to a shared object library (.so) file which is to be copied over onto the robot (for example
using \texttt{scp} tool). The library can be placed for example in the directory \texttt{\$HOME/lib/} in the home directory of the nao user on the
robot. Once copied, the file should be declared inside the file \texttt{'autoload.ini'} as follows:
\texttt{'\$HOME/lib/libpeppercontroller.so'}. After changing the \texttt{'autoload.ini'} file naoqi operating system of the robot should be
rebooted to reread the file. This can be done using the command \texttt{'nao restart'}.

\subsection{Usage}
\noindent Controller works with motion configuration files written in yaml language. Examples of such files are in the
\texttt{<controller-pepper>/config/} directory. All files from this directory should be copied to
\texttt{\$HOME/config-pepper/} directory on the robot as this is the default path where the controller will look for the configuration files 
at runtime. Path of the directory with configuration files can be changed, however this change needs to be reflected in
the PepperController class contructor.\\ \\
\noindent Motion of the robot can be specified using a sequence of motion parameters. In this case on top of the
respective .yaml file one needs to specify the number of motion primitives and below define each motion parameters
primitive.
\noindent Convenient way of communication with the \texttt{PepperController} module is through the Python interface. Python scripts are located
inside the \texttt{<controller-pepper>/python} directory. One can thus use \texttt{'move.py'} script to command a desired specified
sequence of motion (previously defined inside a .yaml file). By default the script connects to the ip adress
\texttt{'10.42.0.61'}. The IP address of the robot can be specified using \texttt{'-b 11.22.33.44'}, port using
\texttt{'-p 9559'}. The default port is 9559. Last parameter is the yaml configuration file with the desired motion specified as 
\texttt{'-c name-of-the-file'}. Examples of configuration files with motion parameters are in the
\texttt{<controller-pepper>/config/} directory. Before using, inside the script one should modify parameters such as desired joints stiffness,
time to reach initial and rest position to their liking.\\ \\

\noindent Here below we include a short description of the calls to the module's interface through python. \\ \\
\begin{tabular}{|l|p{5cm}|}
\hline
Function & Description \\
\hline
\texttt{killALMotionModule()} & remove ALMotion module from naoqi \\
\hline
\texttt{setActuatorsStiffness(time, value)} & set all actuators stiffness to desired
value within given time interval \\
\hline
\texttt{goInitialPose(time)} & go to the initial pose within given time interval \\
\hline
\texttt{startControl()} & start the controller \\
\hline
\texttt{setMPCMotionParameters(filename)} & load the desired motion parameters from the file \\
\hline
\texttt{setMPCMotionParametersIdle()} & set motion parameters to idle \\
\hline
\texttt{stopControl()} & stop the controller \\
\hline
\texttt{goRestPose(time)} & go to the resting pose within given time interval \\
\hline
\texttt{setWheelsStiffness(time, value)} & set wheels stiffness to given value withon given time interval (convenient for moving the
robot) \\
\hline
\texttt{printRootPose()} & print 6D pose of the root of the robot \\
\hline
\texttt{setUpperJointsStiffness(time, value)} & set upper body joints stiffness to given value withon given time interval \\
\hline
\texttt{setActuators(time, value)} & set actuators position to given value withon given time interval \\
\hline
\end{tabular} \\

\noindent Functions above can also be used interactively from, for example, IPython. Implementation of the above
functions can be consulted inside \texttt{<controller-pepper>/controller/pepper\_controller.cpp} file.

\subsection{Usage for visual servoing}

\subsection{Using visualization tool}
\noindent If compiled with logging enabled, one can make use of the visualization tool based off OpenSceneGraph
available on github: https://github.com/bip-team/osg-robot-visualizer.git. \\
\noindent It is possible to, instead of sending commands to the robot, stream them into a file. Such file can then serve
to replay the motion of the robot in the visualization tool. This way one can early detect possible failiures of the
system without running the risk of damaging the hardware.

